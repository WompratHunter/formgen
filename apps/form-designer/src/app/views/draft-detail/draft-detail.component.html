@if (loading()) {
  <div class="detail-loading">
    <mat-spinner diameter="48" aria-label="Loading draft" />
  </div>
} @else if (draft()) {

  <!-- ── Shared fragments ─────────────────────────────────────── -->

  <ng-template #editorHeader>
    <div class="editor-header">
      <div class="editor-header__nav">
        <button mat-icon-button routerLink="/drafts" aria-label="Back to drafts">
          <mat-icon aria-hidden="true">arrow_back</mat-icon>
        </button>
        <h1 class="editor-header__title">Edit Draft</h1>
      </div>
      <div class="editor-header__chips">
        <mat-chip disabled>v{{ draft()!.version }}</mat-chip>
        <fg-status-chip [status]="draft()!.status" />
      </div>
    </div>
  </ng-template>

  <ng-template #editorCard>
    <mat-card>
      <mat-card-content>
        <form [formGroup]="form">

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Form Name</mat-label>
            <input matInput formControlName="name" />
            @if (form.get('name')?.invalid && form.get('name')?.touched) {
              <mat-error>Name is required.</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Layout Columns</mat-label>
            <mat-select formControlName="columns">
              @for (col of columnOptions; track col) {
                <mat-option [value]="col">{{ col }} column{{ col > 1 ? 's' : '' }}</mat-option>
              }
            </mat-select>
          </mat-form-field>

          <mat-divider class="section-divider" />
          <h4 class="section-label">Fields</h4>

          <div
            formArrayName="fields"
            cdkDropList
            (cdkDropListDropped)="dropField($event)"
            aria-label="Reorder form fields"
          >
            @for (field of draft()!.fields; track field.key; let i = $index) {
              <div class="field-row" [formGroupName]="i" cdkDrag>
                <mat-icon cdkDragHandle class="drag-handle" aria-hidden="true">drag_indicator</mat-icon>
                <span class="field-key">{{ field.key }}</span>
                <mat-chip disabled class="field-type-chip">{{ field.type }}</mat-chip>
                <mat-form-field appearance="outline" class="field-label-input">
                  <mat-label>Label</mat-label>
                  <input matInput formControlName="label" />
                </mat-form-field>
              </div>
            }
          </div>

        </form>
      </mat-card-content>

      <mat-card-actions align="end">
        <button
          mat-flat-button
          [disabled]="form.invalid || saving()"
          (click)="save()"
          class="save-btn"
        >
          @if (saving()) {
            <span class="btn-content">
              <mat-spinner diameter="18" aria-hidden="true" />
              Saving…
            </span>
          } @else {
            Save
          }
        </button>
      </mat-card-actions>
    </mat-card>
  </ng-template>

  <ng-template #previewPane>
    <app-preview-panel [renderableForm]="renderableForm()" />
  </ng-template>

  <!-- ── Mobile: tabs ─────────────────────────────────────────── -->

  @if (isMobile()) {
    <div class="detail-mobile">
      <ng-container [ngTemplateOutlet]="editorHeader" />
      <mat-tab-group dynamicHeight>
        <mat-tab label="Edit">
          <div class="tab-pane" aria-label="Form editor">
            <ng-container [ngTemplateOutlet]="editorCard" />
          </div>
        </mat-tab>
        <mat-tab label="Preview">
          <div class="tab-pane" aria-label="Live preview">
            <ng-container [ngTemplateOutlet]="previewPane" />
          </div>
        </mat-tab>
      </mat-tab-group>
    </div>
  } @else {

  <!-- ── Desktop: side-by-side ────────────────────────────────── -->

    <div class="detail-layout">
      <div class="detail-editor" aria-label="Form editor">
        <ng-container [ngTemplateOutlet]="editorHeader" />
        <ng-container [ngTemplateOutlet]="editorCard" />
      </div>
      <div class="detail-preview" aria-label="Live preview">
        <ng-container [ngTemplateOutlet]="previewPane" />
      </div>
    </div>
  }
}
